"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[380],{4585:(e,r,t)=>{t.d(r,{Cy:()=>g,HY:()=>N,XC:()=>A,ru:()=>v});var o=t(2078),a=t(2553),n=t(9708),s=t(9996),i=t(4663);let l=null,u=()=>{if(l)return l;try{let e=(()=>{let e={apiKey:"AIzaSyC-4zmDdj1l60s9QqJiWDTvP7dnubeh2oQ",authDomain:"kupid-2d53e.firebaseapp.com",projectId:"kupid-2d53e",storageBucket:"kupid-2d53e.firebasestorage.app",messagingSenderId:"580509716141",appId:"1:580509716141:web:e333629f72c203102b8024",measurementId:"G-59JMQCW249"};for(let r of["apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId"])if(!e[r])throw Error("Missing required Firebase configuration: ".concat(r));return e})();return l=0===(0,o.Dk)().length?(0,o.Wp)(e):(0,o.Sx)()}catch(e){throw e}},c=null,d=null,y=null,m=null,h=null,w=()=>{if(c)return c;try{let e=u();return c=(0,a.xI)(e),(h=new a.HF).addScope("email"),h.addScope("profile"),h.setCustomParameters({prompt:"select_account"}),c}catch(e){throw e}},p=()=>{if(d)return d;try{let e=u();return d=(0,n.aU)(e)}catch(e){throw e}},f=async()=>{if(m)return m;try{if(!await (0,i.TT)())return null;let e=u();return m=(0,i.P5)(e)}catch(e){return null}},g=()=>w(),v=()=>p(),A=()=>(h||w(),h),N=e=>(null==e?void 0:e.code)&&e.code.startsWith("auth/");w(),p(),(()=>{if(!y)try{let e=u();return y=(0,s.c7)(e)}catch(e){throw e}})(),f(),u()},5380:(e,r,t)=>{t.d(r,{A:()=>u,O:()=>d});var o=t(5155),a=t(2115),n=t(2553),s=t(9708),i=t(4585);let l=(0,a.createContext)({});function u(){let e=(0,a.useContext)(l);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}let c=e=>(null==e?void 0:e.toDate)?e.toDate():e instanceof Date?e:new Date;function d(e){let{children:r}=e,[t,u]=(0,a.useState)(null),[d,y]=(0,a.useState)(null),[m,h]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=(0,i.Cy)(),r=(0,n.hg)(e,async e=>{u(e),e?await w(e.uid):y(null),h(!1)});return()=>r()},[]),(0,a.useEffect)(()=>{let e=()=>{if((null==t?void 0:t.isAnonymous)&&d){let e=new Blob([JSON.stringify({uid:t.uid})],{type:"application/json"});navigator.sendBeacon("/api/cleanup-anonymous",e)}};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[t,d]),(0,a.useEffect)(()=>()=>{},[]);let w=async e=>{try{let r=(0,i.ru)(),t=await (0,s.x7)((0,s.H9)(r,"users",e));if(t.exists()){let r=t.data(),o={...r,createdAt:c(r.createdAt),lastActive:c(r.lastActive)};y(o),await p(e)}else y(null)}catch(e){y(null)}},p=async e=>{try{let r=(0,i.ru)();await (0,s.BN)((0,s.H9)(r,"users",e),{lastActive:s.Dc.now()},{merge:!0})}catch(e){}},f=async()=>{try{h(!0);let e=(0,i.Cy)();await (0,n.zK)(e),h(!1)}catch(e){throw h(!1),e}},g=async()=>{try{h(!0);let e=(0,i.Cy)(),r=(0,i.XC)(),t=await (0,n.df)(e,r);if(t.user.email){let e=(0,i.ru)(),r=(0,s.P)((0,s.rJ)(e,"users"),(0,s._M)("email","==",t.user.email)),o=await (0,s.GG)(r);if(o.empty){let e={uid:t.user.uid,email:t.user.email,displayName:t.user.displayName,photoURL:t.user.photoURL,isGoogleUser:!0};sessionStorage.setItem("pendingGoogleUser",JSON.stringify(e))}else{let r=o.docs[0].id;await (0,s.BN)((0,s.H9)(e,"users",r),{lastActive:s.Dc.now()},{merge:!0})}}else throw Error("Google account does not have an email address");h(!1)}catch(e){if(h(!1),e&&"object"==typeof e&&"code"in e){if("auth/popup-closed-by-user"===e.code)throw Error("Google sign-in was cancelled");if("auth/network-request-failed"===e.code)throw Error("Network error. Please check your internet connection and try again")}throw e}},v=async e=>{if(!t)throw Error("No authenticated user found");try{let r=(0,i.ru)(),o=s.Dc.now(),a=null;{let e=sessionStorage.getItem("pendingGoogleUser");e&&(a=JSON.parse(e),sessionStorage.removeItem("pendingGoogleUser"))}let n={uid:t.uid,username:e.username,age:e.age,gender:e.gender,preferences:e.preferences,isAnonymous:t.isAnonymous,createdAt:o,lastActive:o},l={};(null==a?void 0:a.email)&&(l.email=a.email),(null==a?void 0:a.displayName)&&(l.displayName=a.displayName),(null==a?void 0:a.photoURL)&&(l.photoURL=a.photoURL);let u={location:e.location||null,bodyCount:e.bodyCount||null,bodyType:e.bodyType||null,bodyTypePreference:e.bodyTypePreference||null,secret:e.secret||null,showSecret:e.showSecret||!1,avatar:e.avatar||null,moments:e.moments||[]},d={...n,...l,...u};await (0,s.BN)((0,s.H9)(r,"users",t.uid),d),y({...d,createdAt:c(o),lastActive:c(o)})}catch(e){throw e}},A=async e=>{if(!t||!d)throw Error("No authenticated user or profile found");try{let r=(0,i.ru)(),o={...e,lastActive:s.Dc.now()};await (0,s.BN)((0,s.H9)(r,"users",t.uid),o,{merge:!0});let a={...d,...e,lastActive:new Date};y(a)}catch(e){throw e}},N=async function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0],!(null==t?void 0:t.isAnonymous)||!d)throw Error("Can only upgrade anonymous users");try{let e=(0,i.Cy)(),r=(0,i.XC)(),o=(0,i.ru)(),a=await (0,n.df)(e,r);if(a.user.email){let e=(0,s.P)((0,s.rJ)(o,"users"),(0,s._M)("email","==",a.user.email)),r=await (0,s.GG)(e);if(!r.empty&&r.docs[0].id!==t.uid)return{conflictData:{username:r.docs[0].data().username||"Unknown User"}};let n={uid:a.user.uid,email:a.user.email,displayName:a.user.displayName,photoURL:a.user.photoURL,isGoogleUser:!0};return sessionStorage.setItem("pendingGoogleUser",JSON.stringify(n)),await (0,s.kd)((0,s.H9)(o,"users",t.uid)),{isNewUser:!0}}throw Error("Google account does not have an email address")}catch(e){throw e}},S=async()=>{try{let e=(0,i.Cy)();if((null==t?void 0:t.isAnonymous)&&d)try{let e=(0,i.ru)();await (0,s.kd)((0,s.H9)(e,"users",t.uid))}catch(e){}await (0,n.CI)(e),sessionStorage.removeItem("pendingGoogleUser"),sessionStorage.removeItem("onboardingNavigation"),u(null),y(null)}catch(e){(0,i.HY)(e);try{u(null),y(null),sessionStorage.clear()}catch(e){}throw Error("Logout failed. Your session has been cleared locally.")}},b=()=>!!(null==t?void 0:t.isAnonymous),C=async e=>{try{let r=(0,i.ru)(),o=(0,s.P)((0,s.rJ)(r,"users"),(0,s._M)("email","==",e)),a=await (0,s.GG)(o);if(!a.empty){(null==t?void 0:t.uid)&&d&&await (0,s.kd)((0,s.H9)(r,"users",t.uid));let e=a.docs[0].id;await (0,s.BN)((0,s.H9)(r,"users",e),{lastActive:s.Dc.now()},{merge:!0}),await w(e)}}catch(e){throw e}};return(0,o.jsx)(l.Provider,{value:{user:t,userProfile:d,loading:m,signInAnonymously:f,signInWithGoogle:g,createUserProfile:v,updateUserProfile:A,upgradeToGoogleUser:N,switchToExistingGoogleAccount:C,signOut:S,isGoogleUser:()=>!!t&&!t.isAnonymous&&(!!t.email||!!(null==d?void 0:d.email)),isAnonymousUser:b,shouldShowGoogleLogin:()=>b()&&!!d},children:r})}}}]);